/* 
 * This library manages if you have encoded model/instance details encoded as 
 * data-attributes in JS and you want to pop them into a dialog when the user
 * hovers or clicks on an element. Assumes pklib.js
 */


/** This section is for managing object details encoded into data attribute
 * values in the HTML generated by PHP.
 * First, we declare a global JS object "var decodedObjectCache = {};"
 * to hold/cache the decoded values so we don't have to decode them again every time.
 * 
 * Function "getDecodedData(objtype,objid)" returns the data object details for
 * object of type=objtype and id=objid.
 * 
 * First checks the global cache "decodedObjectCache.type.id" - if it exists, 
 * returns it. If not, checks the page for element of class: 'encoded-data-holder',
 * with the elements "data-encoded-data-objtype=type" and 'data-encoded-data-objid=id'
 * 
 *  If it finds that element, parses the value of 'data-encoded-data-data' into
 *  a JavaScript object, assigns the result to "decodedObjectCache.objtype.objid", and
 *  returns it.
 * 
 * @returns object - the decoded data object.
 */

//var decodedObjectCache = {};
var decodedObjectCache = null;

/** We get the decoded data for a particular object instance (objtype/objid)
 * getDecodedData(objtype,objid): returns the data for that object
 * OR for all instances of that type:
 * getDecodedData(objtype): data for all instances of that type, keyed by ID
 * OR all the encoded data we have on the page:
 * getDecodedData(): ALL the decoded data, keyed by type/id
 * 
 * @param string objtype
 * @param string objid
 * @returns object data
 */


/* As defined in app.blade.php
   var popDefObj = {
        dataModelType:'data-model-type-name',
        dataModelId:'data-model-id',
        jsPopupTmpCallerDataAttr:'data-js-popup-template-calls',
        jsPopupTmpCalledDataAttr:'data-js-popup-template-called',
        encodedDataHolderClass:'encoded-data-holder',
        encDatMdlDataAttr:'data-encoded-data-objtype',
        encDatIdDataAttr:'data-encoded-data-objid',
        encDatDatDataAttr:'data-encoded-data-data',
        popTemplateClass:'pop-hidden-js-template',
        popCallerClass:'pop-details-for-obj',
        popAttrNameDataAttr:'data-enc-attr-name',
        valueTemplateClass:'enc-attr-val-tpl',
        valueHolderClass:'enc-attr-val-holder-tpl'
     };
*/



/**
 * Gets decoded object attribute data for the given model/id - or for all
 * instances of model if id not given, or for all known if neither given
 * @param string|object|nul objtype - if string, the object type. If object,
 *   should be of the form: {objtype:objtype, objid:objid}
 *   if null, all encoded data returned.
 * @param string|null objid
 * @returns {decodedObjectCache}
 */
function getDecodedData(objtype,objid) {
  if (decodedObjectCache === null) {
    inititializeDecodedObjectCache();
  }
  if (isObject(objtype)) {
    objid = objtype.objid;
    objtype = objtype.objtype;
  }
  
  if (objtype === undefined) {
    return decodedObjectCache;
  }
  if (decodedObjectCache[objtype] === undefined) {
    decodedObjectCache[objtype] = {};
    console.error("The cache attribute ["+objtype+"] was undefined");
  }
  if (objid === undefined) {
    return decodedObjectCache[objtype];
  }
  if (decodedObjectCache[objtype][objid] === undefined) {
    decodedObjectCache[objtype][objid] = {};
  }
  return decodedObjectCache[objtype][objid];
}

function inititializeDecodedObjectCache() {
  if (decodedObjectCache === null) {
    decodedObjectCache = {};
  }
  var encodedEls = $('.'+popDefObj.encodedDataHolderClass);
  if (!encodedEls.length) {
    return decodedObjectCache;
  }
  encodedEls.each(function() {
    var objtype = $(this).attr(popDefObj.encDatMdlDataAttr);
    var objid = $(this).attr(popDefObj.encDatIdDataAttr);
    var encoded = $(this).attr(popDefObj.encDatDatDataAttr);
    var decoded =  $.parseJSON(encoded);
    if  (decodedObjectCache[objtype] === undefined) {
      decodedObjectCache[objtype] = {};
    }
    decodedObjectCache[objtype][objid] = decoded;
  });
  return decodedObjectCache;
}


function objDataDecode(objtype, objid) {
  var datael = $('.encoded-data-holder[data-encoded-data-objtype="'+
          objtype+'"][data-encoded-data-objid="'+
          objid + '"]');
  var encoded = datael.attr('data-encoded-data-data');
  //console.log ('encoded:', encoded);
  var decoded =  $.parseJSON(encoded);
  //console.log ('decoded:', decoded);
  return decoded;
}



$(function () {
  //Initialize popDefObj if not already
  if (typeof  popDefObj === 'undefined') {
   window.popDefObj = {
        dataModelType:'data-model-type-name',
        dataModelId:'data-model-id',
        jsPopupTmpCallerDataAttr:'data-js-popup-template-calls',
        jsPopupTmpCalledDataAttr:'data-js-popup-template-called',
        encodedDataHolderClass:'encoded-data-holder',
        encDatMdlDataAttr:'data-encoded-data-objtype',
        encDatIdDataAttr:'data-encoded-data-objid',
        encDatDatDataAttr:'data-encoded-data-data',
        popTemplateClass:'pop-hidden-js-template',
        popCallerClass:'pop-details-for-obj',
        popAttrNameDataAttr:'data-enc-attr-name',
        valueTemplateClass:'enc-attr-val-tpl',
        valueHolderClass:'enc-attr-val-holder-tpl'
     };
     console.log("!!!popDefObj undefined in the template, using defaults !!!");
  }
  //console.log("Trying to get data atts");
  //var res = getDecodedData('borrower','1');
  var res = getDecodedData();
  //console.log("RES:", res);
  /*
  var data_atts = $('div.data-atts-holder');
  if (data_atts.length) {
    var enc_data = data_atts.attr('data-atts');
    console.log("The encoded data", enc_data);
    var dec_obj = $.parseJSON(enc_data);
    console.log("The Decoded Obj:", dec_obj);
  }
  */






/** Special pop-up JS to show model/id details when hovering...
 * 
 * @param {type} theVar
 * @param {type} subStr
 * @returns {Boolean}
 */
//$('body').on('hover', '.'+popDefObj.popTemplateClass, function (event) {
//$('body').on('hover', '['+popDefObj.jsPopupTmpCallerDataAttr+']', function (event) {
//$('body').on('hover', '.'+popDefObj.popCallerClass, function (event) {
//Putting this INSIDE init function, to be sure we get popDefObj - remove if it breaks! 28 Nov 16
$('body').on('click', '.'+popDefObj.popCallerClass, function (event) {

  var src = $(event.target).attr(popDefObj.jsPopupTmpCallerDataAttr);
  if (!src) return;
  var dlg = $('.'+popDefObj.popTemplateClass+'['+popDefObj.jsPopupTmpCalledDataAttr+'="' + src + '"]');
  if (dlg.length === 0) return;
  var dlgHtml = dlg.prop('outerHTML');
  //console.log("DLGHTML: "+dlgHtml);
  //Find the nearest parent with model & id set
  var inst = $(this).closest('['+popDefObj.dataModelType+']');
  var model = inst.attr(popDefObj.dataModelType);
  var id = inst.attr(popDefObj.dataModelId);
  if (!id || !model) {
    console.error("Failed to get one of ["+model+']['+id+']');
    return false;
  }
  var encdata=getDecodedData(model,id);
  if (!encdata || !isObject(encdata)) {
    console.error("Failed to get encdata for ["+model+']['+id+']: Got:', encdata);
    return false;
  }
  //console.log("Got ENCDATA!", encdata);
  dlg = buildDetailDialog(dlgHtml, encdata);

  var dlg_title = dlg.find('.'+popDefObj.titleHolderClass).text();

  if ((dlg_title === undefined) || !dlg_title) dlg_title='Details';
  //console.log("Got dlg!", dlg.html(), 'title:', dlg_title);
  var dialogOpts = {
    modal: true,
    autoOpen: true,
    width: 600,
    title: dlg_title,
    buttons: [{
        text: 'Close',
        click: function () {
          $(this).dialog('destroy');
        }
      }
    ]
  };
  //var dialogOptions = dialogDefaults;
  //dlg.modal('show');
  dlg.dialog(dialogOpts);

});


/** Like above, but instead of clickable dialog, hoverable details.. */
//$('body').on('hover', '.'+popDefObj.popCallerClass, function (event) {
$('body').on( {
    mouseenter: function (event) {
      console.log("THE TARGET", event.target);
      var jqtarget = $(event.target);
      var src = $(event.target).attr(popDefObj.jsPopupTmpCallerDataAttr);
      if (!src) return;
      var dlg = $('.'+popDefObj.hoverTemplateClass+'['+popDefObj.jsPopupTmpCalledDataAttr+'="' + src + '"]');
      if (dlg.length === 0) return;
      var dlgHtml = dlg.prop('outerHTML');
      //Find the nearest parent with model & id set
      var inst = $(this).closest('['+popDefObj.dataModelType+']');
      var model = inst.attr(popDefObj.dataModelType);
      var id = inst.attr(popDefObj.dataModelId);
      if (!id || !model) {
        console.error("Failed to get one of ["+model+']['+id+']');
        return false;
      }
      var encdata=getDecodedData(model,id);
      if (!encdata || !isObject(encdata)) {
        console.error("Failed to get encdata for ["+model+']['+id+']: Got:', encdata);
        return false;
      }
      dlg = buildHoverDetailDialog(dlgHtml, encdata);
      dlg.addClass('block');
      var dlg_title = dlg.find('.'+popDefObj.titleHolderClass).text();
      if ((dlg_title === undefined) || !dlg_title) dlg_title='Details';
      var aframe = $(popDefObj.hoverHtmlTemplate);
      aframe.append(dlg);
      jqtarget.append(aframe);
      //$('body').append(aframe);
    },
    mouseleave: function () {
      $('.hover-detail-frame').remove();
    }
}, '.'+popDefObj.popCallerClass);

});
        


/** Takes an encoding template and recursively iterates through it building
 * the custom data dialog
 * @param HTML String/jQuery domBit - the template or part of it
 * @param plain object encdata - the data for the model instance
 * @param boolean hideempty - default: true ('false' option not implemented yet)
 *   - if true, don't show elements for which there is no data
 * @returns HTML string/DOM for the dialog from the template, with values inserted
 */
function buildDetailDialog(template,encdata,hideempty) {
  hideempty = (hideempty === undefined)?true:hideempty;
  if (isEmpty(encdata) && hideempty) return false;
  template=jQuerify(template).clone();
  if (!template.length) {
    console.error("Couldn't get the template!");
    return false;
  }
  var dataFields = template.find('['+popDefObj.popAttrNameDataAttr+']');
  dataFields.each(function() {
    console.log("In each data-el - this: ", this);
    var jqthis = $(this);
    var encAttName = jqthis.attr(popDefObj.popAttrNameDataAttr);
    if ((encAttName === undefined) || !encAttName) { //Bad encAttName - delete
      console.error("The template had a bad data-attribute name");
      template.closest('.'+popDefObj.valueTemplateClass).remove();
    }
    if (encdata[encAttName] === undefined) {
      if (hideempty) template.closest('.'+popDefObj.valueTemplateClass).remove();
    } else { //We have a value - insert it!
      jqthis.htmlFormatted(encdata[encAttName]);
    }
  });
  return template;
}

function buildHoverDetailDialog(template,encdata,hideempty) {
  hideempty = (hideempty === undefined)?true:hideempty;
  if (isEmpty(encdata) && hideempty) return false;
  template=jQuerify(template).clone();
  if (!template.length) {
    console.error("Couldn't get the template!");
    return false;
  }


/*
      //Manage arrays here ...
      var parentArrs  = dlg.find('.'+popDefObj.arrayParentClass);
      parentArrs.each(function (idx) {
        $(this).child_arr = $(this).find('.'+popDefObj.arrayChildClass).clone();
        $(this).find('.'+popDefObj.arrayChildClass).remove();
      });
      console.log("Parent Arrs stripped:",parentArrs.html());
      parentArrs.each(function (idx) {
        console.log("Trying to see the child array...",$(this).child_arr.html());
      });
  */

    var arrParCl = '.'+popDefObj.arrayParentClass;
    var arrChldCl = '.'+popDefObj.arrayChildClass;
    var attrDataSel = '['+popDefObj.popAttrNameDataAttr+']';

console.log("The var sels:", arrParCl,arrChldCl, attrDataSel);
var tstDF1 = template.find(attrDataSel);

//The below filters out the parent arrays as well
//var tstDF2 = template.find(attrDataSel).not(arrParCl +', '+arrParCl +' *');
//
//This keeps the parent arrays, but filters out the children arrays
var dataFields = template.find(attrDataSel).not(arrParCl +' *');

//console.log("LN1: ",tstDF1.length, "LN2: ", tstDF2.length);
//console.log("tst2: ", tstDF2);


  //var dataFields = template.find('['+popDefObj.popAttrNameDataAttr+']').not(arrParCl + ' '+arrParCl +' *');
  //var topDataFields = dataFields.filter()
//  console.log("DataFields:", dataFields);
  //tstDF2.each (function() {
   // console.log("tstDF2  DATAFIELD", this);

  //});
  //dataFields.each (function() {
   // console.log("THIS DATAFIELD", this);

  //});



  dataFields.each(function() {
    //console.log("In each data-el - this: ", this);
    var jqthis = $(this);
    var encAttName = jqthis.attr(popDefObj.popAttrNameDataAttr);
    if ((encAttName === undefined) || !encAttName) { //Bad encAttName - delete
      console.error("The template had a bad data-attribute name");
      template.closest('.'+popDefObj.valueTemplateClass).remove();
    }
    if (encdata[encAttName] === undefined) {
      if (hideempty) template.closest('.'+popDefObj.valueTemplateClass).remove();
    } else if (isArray(encdata[encAttName])) { //We have an array - what do we do?
      //Not elegant, but - length either 0 (delete child), 1 (populate child)
      // > 1 - copy child
      var len = encdata[encAttName].length;
      console.log("ENCATTNAME: "+encAttName+' len '+ len + ' encattdata ',encdata[encAttName] );
      //if (!len) jqthis.find(arrChldCl).remove();
      var childClone =  jqthis.find(arrChldCl).clone();
      for (var i = 0 ; i < len ; i++ ) {
        var datarow = encdata[encAttName][i];
        var childArrCopy =  childClone.clone();
        console.log("ChildArrayCopy: ",childArrCopy );
        childArrCopy.removeClass('hidden');
        var dataEls = childArrCopy.find(attrDataSel);
        dataEls.each(function () {
          var jqcdat = $(this);
          var cencAttName = jqcdat.attr(popDefObj.popAttrNameDataAttr);
          jqcdat.htmlFormatted(datarow[cencAttName]);
        });
        jqthis.append(childArrCopy);
      }
    } else { //We have a value - insert it!
      jqthis.htmlFormatted(encdata[encAttName]);
    }
  });






//This kind of works, but not for arrays. Fiddle with it for arrays, but keep the
// original...
/*
  dataFields.each(function() {
    //console.log("In each data-el - this: ", this);
    var jqthis = $(this);
    var encAttName = jqthis.attr(popDefObj.popAttrNameDataAttr);
    if ((encAttName === undefined) || !encAttName) { //Bad encAttName - delete
      console.error("The template had a bad data-attribute name");
      template.closest('.'+popDefObj.valueTemplateClass).remove();
    }
    if (encdata[encAttName] === undefined) {
      if (hideempty) template.closest('.'+popDefObj.valueTemplateClass).remove();
    } else { //We have a value - insert it!
      jqthis.htmlFormatted(encdata[encAttName]);
    }
  });
  */




  return template;
}

/** Takes an encoding template and recursively iterates through it building
 * the custom data dialog
 * @param HTML String/jQuery domBit - the template or part of it
 * @param plain object encdata - the data for the model instance
 * @param boolean hideempty - default: true ('false' option not implemented yet)
 *   - if true, don't show elements for which there is no data
 * @returns HTML string/DOM for the dialog from the template, with values inserted
 */
/*
function buildDetailsDialog(domBit, encdata, hideempty) {
  domBit = jQuerify(domBit).clone();
  if (domBit.hasClass(popDefObj.valueTemplateClass)) {
    //... it is a template row for SOME data element. Get the enc data key 
    var enc_att_name = domBit.attr(popDefObj.popAttrNameDataAttr);
    if ((enc_att_name === undefined) || !enc_att_name ||
            (encdata[enc_att_name] === undefined)) {
      //We don't have a value for this row; leave blank
      return false;
    }
    var encval = encdata[enc_att_name]; //We have a value - insert it 

  }

}

function descendAndSet(template, encdata) {
  template = jQuerify(template).clone();
  if (template.hasClass(popDefObj.valueTemplateClass)) {

  }
  var innershell = $(template[0].cloneNode());
  var innercontent = template.contents();
  innercontent.each(function() {
    innershell.append(descendAndSet(this));

  });
  
}
*/

